<!DOCTYPE html>
<html lang="en">

<head>
{% load static %}
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>TracKaPSITE | Member Registration </title>

    <!-- Custom fonts for this template-->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="{% static 'css/sb-admin-2.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body class="bg-gradient-primary">
    <div class="card" style="position: absolute; top: 10%; left: 30%; right: 30%; transform: translate(0%, 0%);">
        <div class="card-body p-0">
            <div class="row">
                <div class="col-lg-12">
                    <a href="{% url 'login' %}" class="btn btn-secondary" title="Go Back">
                        <i class="fas fa-arrow-left"></i>&nbsp;&nbsp; Back</a>
                    <div class="p-5">
                        <div class="text-center">
                            <h1 class="h4 text-gray-900 mb-4">New Member Registration</h1>
                            {% for sy in school_year %}
                                {% if sy.id == active_school_year_id and sy.status == 1 %}
                                    <div class="form-group">
                                        <label>School Year:</label>
                                        <span><b>{{ sy.sy_start }} - {{ sy.sy_end }}</b></span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <form class="user" method="post" action="{% url 'registration_new' %}" enctype="multipart/form-data" onsubmit="return validateForm()">
                            {% csrf_token %}
                            {% include 'includes/messages.html' %}
                            <input type="hidden" class="form-control text-uppercase" id="membertype_id" name="membertype_id" value="1" required/> 
                            <input type="hidden" class="form-control text-uppercase" id="school_year_id" name="school_year_id" value="{{active_school_year_id}}" required/>
                            <!-- Personal Information -->
                            <fieldset class="border rounded p-3 mb-4">
                                <legend class="w-auto px-2" style="font-size:1.1rem;">Personal Information</legend>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="salutation_id">Salutation</label>
                                        <select class="form-control" id="salutation_id" name="salutation_id" required>
                                            <option value="" disabled selected>SELECT SALUTATION</option>
                                            {% for salutation in salutations %}
                                                <option value="{{ salutation.id }}">{{ salutation.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="position">Position</label>
                                        <input type="text" class="form-control text-uppercase" id="position" placeholder="Position" name="position" required/>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-4">
                                        <label for="first_name">First Name</label>
                                        <input type="text" class="form-control text-uppercase" id="first_name" placeholder="First Name" name="first_name" required/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="last_name">Last Name</label>
                                        <input type="text" class="form-control text-uppercase" id="last_name" placeholder="Last Name" name="last_name" required/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="middle_name">Middle Name</label>
                                        <input type="text" style="text-transform: uppercase;" class="form-control" id="middle_name" placeholder="Middle Name" name="middle_name"/>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="birthdate">Birthdate</label>
                                        <input type="date" class="form-control" id="birthdate" name="birthdate" required/>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="email">Email Address</label>
                                        <input type="email" class="form-control text-lowercase" id="email" placeholder="Email Address" name="email" required/>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="it_topic_id">Interested IT Topic(s)</label>
                                        <select class="form-control" id="it_topic_id" name="it_topic_id" multiple size="4">
                                            {% for topic in it_topics %}
                                                <option value="{{ topic.id }}">{{ topic.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div id="itSelected" class="mt-2"></div>
                                        <small id="itLimitWarning" class="form-text text-danger d-none">You can select up to 3 topics.</small>
                                        <small class="form-text text-muted">Click to toggle selection (no Ctrl required). Selected items shown below.</small>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="contact_no">Contact Number</label>
                                        <input type="tel" class="form-control" id="contact_no" placeholder="eg. 09123456789" name="contact_no" maxlength="11" required pattern="09[0-9]{9}" title="Please enter a valid 11-digit contact number."/>                        
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="facebook_profile_link">Facebook Profile Link:</label>
                                        <input type="url" class="form-control" id="facebook_profile_link" name="facebook_profile_link" placeholder="eg. https://www.facebook.com/yourprofile" required />
                                    </div>
                                </div>
                                <!-- Removed extra position row, now beside salutation above -->
                            </fieldset>
                            <!-- Account Information -->
                            <fieldset class="border rounded p-3 mb-4">
                                <legend class="w-auto px-2" style="font-size:1.1rem;">Account Information</legend>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="membershiptype_id">Membership Type
                                            <i class="fas fa-info-circle" data-toggle="tooltip" title="Select your membership type. Each type has different benefits and pricing."></i>
                                        </label>
                                        <select class="form-control" id="membershiptype_id" name="membershiptype_id" required>
                                            <option value="" disabled selected>SELECT MEMBERSHIP TYPE</option>
                                            {% for membershiptype in membershiptypes %}
                                                <option value="{{ membershiptype.id }}">{{ membershiptype.name }} - {{membershiptype.price}} PESOS</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="organization_id">School/Organization</label>
                                        <select class="form-control" id="organization_id" name="organization_id" required>
                                            <option value="" disabled selected>SELECT SCHOOL / ORGANIZATION</option>
                                            {% for organization in organizations %}
                                                <option value="{{ organization.id }}">{{ organization.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="username">Username (Auto-generated)</label>
                                        <input type="text" class="form-control" id="username" name="username" required placeholder="Username will be auto-generated or make a custom"/>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="officertype_id" style="display:none;">PSITE CL Officer?</label>
                                        <select class="form-control" id="officertype_id" name="officertype_id" required style="display:none;">
                                            <option value="1" selected>MEMBER ONLY</option>
                                            {% for officertype in officertypes %}
                                                {% if officertype.id != 1 and officertype.id != customuser.officertype_id %}
                                                    <option value="{{ officertype.id }}">{{ officertype.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </fieldset>
                            <!-- Payment Information -->
                            <fieldset class="border rounded p-3 mb-4">
                                <legend class="w-auto px-2" style="font-size:1.1rem;">Payment Information</legend>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="proof_of_payment">Proof of Payment:</label>
                                        <input type="file" class="form-control" id="proof_of_payment" name="proof_of_payment" accept=".pdf, .jpg, .jpeg, .png">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="payment_date">Payment Date:</label>
                                        <input type="date" class="form-control" id="payment_date" name="payment_date" required/>
                                    </div>
                                </div>
                            </fieldset>
                            <div id="notificationArea" class="alert alert-danger d-none" role="alert"></div>
                            <div class="form-group mb-3">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="termsCheckbox" name="terms_accepted" value="true" required>
                                    <label class="custom-control-label" for="termsCheckbox">I accept the terms of membership.</label>
                                </div>
                                <div class="agreement mt-2 text-muted" style="font-size:0.95rem;">
                                    If accepted for membership, I agree to comply with the requirements of the By-Laws, and all regulations adopted by the Society with full knowledge of the responsibility imposed upon me.
                                </div>
                            </div>
                            <button id="registerButton" class="btn btn-primary btn-block py-2 font-weight-bold" type="submit" onclick="return validateForm()">Register</button>
                            <hr>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    function validateForm() {
        var checkbox = document.getElementById("termsCheckbox");
        var notificationArea = document.getElementById("notificationArea");
        notificationArea.innerHTML = '';
        notificationArea.classList.add('d-none');
        if (!checkbox.checked) {
            notificationArea.innerHTML += "You must agree to the terms of service before registering.<br>";
            notificationArea.classList.remove('d-none');
            return false;
        }
        return true;
    }

    document.getElementById('contact_no').addEventListener('input', function (e) {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    document.getElementById('birthdate').value = `${year}-${month}-${day}`;
    document.getElementById('payment_date').value = `${year}-${month}-${day}`;

    document.getElementById("contact_no").addEventListener("input", function() {
        const contactNo = this.value;
        const errorMessage = document.getElementById("contactError");
        if (errorMessage) {
            errorMessage.textContent = '';
        }
        if (contactNo.length > 0 && !/^09[0-9]{9}$/.test(contactNo)) {
            if (!errorMessage) {
                const errorDiv = document.createElement("div");
                errorDiv.id = "contactError";
                errorDiv.className = "text-danger";
                this.parentNode.appendChild(errorDiv);
            }
            errorMessage.textContent = "Contact number must start with '09' and be 11 digits long.";
        }
    });

    // âœ… Auto-generate Username based on first name + last name + random 2-digit number
    function generateUsername() {
        const firstName = document.getElementById('first_name').value.trim().toLowerCase();
        const lastName = document.getElementById('last_name').value.trim().toLowerCase();
        if (firstName && lastName) {
            const randomNum = Math.floor(Math.random() * 90 + 10); // 10-99
            const username = `${firstName.charAt(0)}${lastName}${randomNum}`;
            document.getElementById('username').value = username;
        }
    }

    document.getElementById('first_name').addEventListener('input', generateUsername);
    document.getElementById('last_name').addEventListener('input', generateUsername);

    // Multi-select UX for IT Topics: click to toggle without Ctrl and show badges
    document.addEventListener('DOMContentLoaded', function() {
        const select = document.getElementById('it_topic_id');
        const container = document.getElementById('itSelected');
        if (!select || !container) return;

        function updateBadges() {
            container.innerHTML = '';
            const selectedCount = Array.from(select.options).filter(o => o.selected).length;
            const warn = document.getElementById('itLimitWarning');
            if (warn) {
                if (selectedCount >= 3) warn.classList.remove('d-none');
                else warn.classList.add('d-none');
            }
            Array.from(select.options).forEach(function(opt) {
                if (opt.selected) {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-primary mr-1 p-2';
                    badge.textContent = opt.text;
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-sm btn-light ml-2';
                    btn.textContent = 'x';
                    btn.addEventListener('click', function() {
                        opt.selected = false;
                        updateBadges();
                    });
                    badge.appendChild(btn);
                    container.appendChild(badge);
                }
            });
        }

        // Allow clicking options to toggle selection without requiring Ctrl
        select.addEventListener('mousedown', function(e) {
            if (e.target && e.target.tagName === 'OPTION') {
                e.preventDefault();
                const option = e.target;
                const currentlySelected = Array.from(select.options).filter(o => o.selected).length;
                // if attempting to select (option not selected) and already at limit, block
                if (!option.selected && currentlySelected >= 3) {
                    const warn = document.getElementById('itLimitWarning');
                    if (warn) {
                        warn.classList.remove('d-none');
                    }
                    return;
                }
                // toggle selection
                option.selected = !option.selected;
                updateBadges();
            }
        });

        // initialize badges if any preselected
        updateBadges();
    });
</script>

</body>
</html>
