
{% extends "includes/base.html" %}
{% load static %}
{% block content %}  



    <!-- Main Content -->
 
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Welcome, {{user.username}}!</h2>
        {% comment %} <button class="btn btn-outline-light bg-primary text-white">Logout</button> {% endcomment %}
      </div>

<!-- Stats Cards -->
 <div class="row mb-4">
    <div class="col-12 col-md-4 mb-3">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-l font-weight-bold text-success text-uppercase mb-1">
                            Registered Members</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">246</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                        <span class="badge bg-success">1</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div class="col-12 col-md-4 mb-3">
          <div class="card text-bg-light  shadow h-100">
            <div class="card-body">
              <h5 class="card-title">Upcoming Events</h5>
              <p class="card-text fs-3 fw-bold text-success">3</p>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4 mb-3">
          <div class="card text-bg-light shadow h-100">
            <div class="card-body">
              <h5 class="card-title">Pending Approvals</h5>
              <p class="card-text fs-3 fw-bold text-danger">5</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4 mb-3">
        <div class="card text-bg-light shadow h-100">
          <div class="card-body" id="subscription-status-card">
            <h5 class="card-title">Subscription Status</h5>
            <div id="membership-expiry-message"></div>
          </div>
        </div>
      </div>

      <!-- Notifications / Approvals -->
      <div class="card mb-4 shadow">
        <div class="card-header">
          Recent Notifications
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item">New member registration pending approval</li>
          <li class="list-group-item">Event feedback submitted by members</li>
          <li class="list-group-item">Attendance for AI Forum has been finalized</li>
        </ul>
      </div>

      <!-- Chart Placeholder -->
      <div class="card  shadow">
        <div class="card-header">
          Member Participation Overview
        </div>
        <div class="card-body text-center text-muted" style="height: 200px;">
          [Analytics Chart Placeholder]
        </div>
      </div>

    <!-- DITO ANG END NG BODY. WAG KA LALAMPAS -->
<!-- DITO ANG END NG BODY. WAG KA LALAMPAS -->
</div>
</div>

      <!-- Subscription Status Modal -->
 <div class="modal fade" id="subscriptionStatusModal" tabindex="-1" aria-labelledby="subscriptionStatusModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="subscriptionStatusModalLabel">Subscription Status</h5>
              <button type="button" class="btn-close" id="modal-close-btn" data-bs-dismiss="modal" aria-label="Close" style="display:none;"></button>
            </div>
            <div class="modal-body">
              <div id="membership-expiry-message-modal"></div>
            </div>
            <div class="modal-footer">
              <a href="{% url 'registration_renew' %}" class="btn btn-primary" id="renew-btn-modal" style="display:none;">Renew</a>
              <a href="{% url 'login' %}" class="btn btn-outline-danger">Logout</a>
            </div>
          </div>
        </div>
      </div>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    var expiry = "{{ membership_expiry|date:'Y-m-d' }}";
    var syStatus = "{{ membership_sy_status }}";
    var msg = '';
    var showRenew = false;

    // If we have an expiry date, always show it in the card and modal.
    if (expiry) {
      var today = new Date();
      var expiryDate = new Date(expiry);
      var diff = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

      if (diff < 0) {
        // Already expired
        msg = '<span class="text-danger fw-bold">Expired on ' + expiry + '</span>';
        showRenew = true;
      } else if (diff <= 30) {
        // Expiring soon
        msg = '<span class="text-warning fw-bold">Expiring in ' + diff + ' day' + (diff !== 1 ? 's' : '') + ' (' + expiry + ')</span>';
        showRenew = true;
      } else {
        // Future expiry
        msg = '<span class="text-success fw-bold">Active until ' + expiry + '</span>';
      }

      // If school_year.status is not active (not '1'), mark this as a previous subscription
      if (syStatus && String(syStatus) !== '1') {
        msg += ' <small class="text-muted">(previous subscription)</small>';
      }
    } else {
      msg = '<span class="text-secondary">No active subscription found.</span>';
    }

    // For card
    var cardEl = document.getElementById('membership-expiry-message');
    if (cardEl) cardEl.innerHTML = msg;
    // For modal
    var modalEl = document.getElementById('membership-expiry-message-modal');
    if (modalEl) modalEl.innerHTML = msg;

    var renewBtn = document.getElementById('renew-btn-modal');
    var closeBtn = document.getElementById('modal-close-btn');
    if (renewBtn) {
      renewBtn.style.display = showRenew ? 'inline-block' : 'none';
      if (showRenew) {
        // Hide close button until renewed (if desired behavior)
        if (closeBtn) closeBtn.style.display = 'none';
        renewBtn.addEventListener('click', function() {
          if (closeBtn) closeBtn.style.display = '';
        });
      } else {
        if (closeBtn) closeBtn.style.display = '';
      }
    }

    // Open modal automatically only when renewal/expiry action is needed
    if (showRenew && window.bootstrap && bootstrap.Modal) {
      var modal = new bootstrap.Modal(document.getElementById('subscriptionStatusModal'), {
        backdrop: 'static',
        keyboard: false
      });
      modal.show();
    }
  });
</script>
{% endblock %}
