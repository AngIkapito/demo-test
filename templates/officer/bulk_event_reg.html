{% extends "includes/base.html" %}
{% load static %}

{% block content %}
<div class="mt-3 p-3">
	<div class="card">
		{% include 'includes/messages.html' %}
		<div class="card-body">
			<h5 class="mb-2">Preview</h5>
			{% if event %}
			<div class="d-flex justify-content-between align-items-center mb-2">
				<div>
					<strong class="me-2">Active Event:</strong>
					<span class="fw-bold text-primary">{{ event.title }}{% if event.file_tag %} ({{ event.file_tag }}){% endif %}</span>
				</div>
				<div class="text-end">
					{% if event.status == 'active' and event.template_path %}
						<div class="small text-muted mb-1">Download the template here:</div>
						<a href="{{ MEDIA_URL|default:'/media/' }}{{ event.template_path }}" class="btn btn-outline-primary btn-sm" download>
							<i class="fas fa-download"></i>&nbsp;Template
						</a>
					{% endif %}
				</div>
			</div>
			{% endif %}
			<div class="mb-3">
				<form method="post" action="{% url 'upload_bulk_event_reg_officer' %}" enctype="multipart/form-data" class="row g-2 align-items-end">
					{% csrf_token %}
					<div class="col-auto">
						<input type="file" name="excel_file" id="excel_file" class="form-control" accept=".csv,.xlsx" />
					</div>
					<div class="col-auto d-flex gap-2">
						<button type="submit" name="action" value="upload" class="btn btn-primary">Upload</button>
					</div>
				</form>
			</div>
			<script>
			// Simple helper to reveal table after successful upload
			(function(){
				const form = document.querySelector('form[action="{% url 'upload_bulk_event_reg_officer' %}"]');
				if(form){
					form.addEventListener('submit', function(){
						const tbl = document.querySelector('.table-responsive');
						if(tbl){ tbl.style.display = ''; }
					});
				}
			})();
			</script>
			{% if preview_rows %}
			<div class="table-responsive">
				<form method="post" action="{% url 'save_bulk_event_reg_officer' %}" class="mb-2" id="save-form">
                    {% csrf_token %}
					<input type="hidden" name="preview_json" id="preview_json" value="">
                    <button type="submit" class="btn btn-success">Save</button>
                </form>
				<script>
				(function(){
					// Serialize preview_rows into hidden input for POST using JSON safely
					// Embed JSON
					// Note: json_script outputs a <script> tag with the JSON content
				})();
				</script>
				{{ preview_rows|json_script:"preview-data" }}
				<script>
				(function(){
					var el = document.getElementById('preview-data');
					var data = [];
					if (el && el.textContent) {
						try { data = JSON.parse(el.textContent); } catch(e) { data = []; }
					}
					var input = document.getElementById('preview_json');
					if (input) { input.value = JSON.stringify(data); }
				})();
				</script>
				<table class="table table-sm table-bordered">
					<thead>
						<tr>
							<th>Last Name</th>
							<th>First Name</th>
							<th>Middle</th>
							<th>Contact Number</th>
							<th>Email</th>
							<th>Attending As</th>
							<th>Is Competitor</th>
							<th>If Competitor</th>
							<th>Is Coach</th>
							<th>If Coach</th>
							<th>T-shirt Size</th>
						</tr>
					</thead>
					<tbody>
						{% for r in preview_rows %}
						<tr>
							<td>{{ r.last_name }}</td>
							<td>{{ r.first_name }}</td>
							<td>{{ r.middle }}</td>
							<td>{{ r.contact_number }}</td>
							<td>{{ r.email|default:'' }}</td>
							<td>{{ r.attending_as }}</td>
							<td>{{ r.is_competitor }}</td>
							<td>{{ r.if_competitor }}</td>
							<td>{{ r.is_coach }}</td>
							<td>{{ r.if_coach }}</td>
							<td>{{ r.tshirt_size }}</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
			{% else %}
			<p class="text-muted mb-0">No preview data available.</p>
			{% endif %}
		</div>
	</div>
</div>
{% endblock %}
