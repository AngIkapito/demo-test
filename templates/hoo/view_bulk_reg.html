{% extends "includes/base.html" %}
{% load static %}

{% block content %}
{% include 'includes/messages.html' %}

<div class="card shadow mb-4">
	<div class="card-body">
		<div class="col-sm-12">
			<div class="d-sm-flex align-items-center mb-4">
				<a href="{% url 'hoo_home' %}" class="btn btn-secondary" title="Go Back">
					<i class="fas fa-arrow-left"></i>&nbsp;&nbsp; Back
				</a>
				<h1 class="h3 mb-0 text-gray-800 mx-auto">Member Event Registration</h1>
			</div>

			<!-- Bulk action controls (right-aligned) -->
			<div class="mb-3 d-flex justify-content-end">
				<div class="me-3">
					<label for="eventFilter" class="form-label mb-1 small">Filter Event</label>
					<select id="eventFilter" class="form-select form-select-sm">
						<option value="">All Events</option>
						{% for ev in events %}
							<option value="{{ ev.id }}" data-status="{{ ev.status }}" {% if selected_event_id and ev.id == selected_event_id %}selected{% endif %}>{{ ev.title }} {% if ev.status == 'active' %}(active){% endif %}</option>
						{% endfor %}
					</select>
				</div>
				<div class="btn-group" role="group" aria-label="Bulk actions">
					<button id="selectAllBtn" class="btn btn-primary btn-sm">Select All</button>
					<button id="approveSelectedBtn" class="btn btn-success btn-sm">Approve Selected</button>
					<button id="declineSelectedBtn" class="btn btn-danger btn-sm">Decline Selected</button>
					<button id="presentSelectedBtn" class="btn btn-warning btn-sm">Present Selected</button>
					<button id="absentSelectedBtn" class="btn btn-secondary btn-sm">Absent Selected</button>
				</div>
			</div>
		</div>

		<div class="table-responsive">
			<table class="table table-bordered text-center text-uppercase" id="dataTable" width="100%" cellspacing="0">
				<thead>
					<tr>
						<th></th>
						<th>Last Name</th>
						<th>First Name</th>
						<th>School</th>
						<th>Attending As</th>
						<th class="text-center">Approval Status</th>
						<th class="text-center">Attendance Status</th>
						<th class="text-center">Actions</th>
					</tr>
				</thead>
				<tfoot>
					<tr>
						<th></th>
						<th>Last Name</th>
						<th>First Name</th>
						<th>School</th>
						<th>Attending As</th>
						<th class="text-center">Approval Status</th>
						<th class="text-center">Attendance Status</th>
						<th class="text-center">Actions</th>
					</tr>
				</tfoot>
				<tbody>
					{% for reg in bulk_regs %}
					<tr data-event-id="{{ reg.event_id }}">
						<td class="align-middle"><input type="checkbox" class="member-checkbox" value="{{ reg.id }}"></td>
						<td>{{ reg.last_name }}</td>
						<td>{{ reg.first_name }}</td>
						<td>
							{% if reg.registered_by and reg.registered_by.organization %}
								{{ reg.registered_by.organization.name }}
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>{{ reg.attending_as|default:"" }}</td>
						<td class="text-center align-middle">
							{% if reg.is_approved %}
								<span class="badge bg-success">Approved</span>
							{% else %}
								<span class="badge bg-danger">Declined</span>
							{% endif %}
						</td>
						<td class="text-center align-middle">
							{% if reg.is_present %}
								<span class="badge bg-success">Present</span>
							{% else %}
								<span class="badge bg-danger">Absent</span>
							{% endif %}
						</td>
						<td class="text-center">
							{% if reg.registered_by %}
								<div class="btn-group" role="group" aria-label="actions">
									<button class="btn btn-sm btn-info view-bulk-btn" data-member-id="{{ reg.registered_by.id }}" data-event-id="{{ reg.event_id }}" title="View Bulk" {% if not reg.is_approved or not reg.is_present %}disabled{% endif %}>
										<i class="fas fa-eye"></i>
									</button>

									{% if reg.is_approved %}
										<button class="btn btn-sm btn-danger approve-btn" data-id="{{ reg.id }}" title="Decline">Decline</button>
									{% else %}
										<button class="btn btn-sm btn-success approve-btn" data-id="{{ reg.id }}" title="Approve">Approve</button>
									{% endif %}

									{% if reg.is_present %}
										<button class="btn btn-sm btn-warning present-btn" data-id="{{ reg.id }}" title="Absent" {% if not reg.is_approved %}disabled{% endif %}>Absent</button>
									{% else %}
										<button class="btn btn-sm btn-primary present-btn" data-id="{{ reg.id }}" title="Present" {% if not reg.is_approved %}disabled{% endif %}>Present</button>
									{% endif %}
								</div>
							{% else %}
								-
							{% endif %}
						</td>
					</tr>
					{% empty %}
					<tr>
						<td colspan="8" class="text-center">No bulk registrations found.</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
	</div>

<script>
   $(document).ready(function() {
	   $('#dataTable').DataTable({
		   "order": [[ 1, "asc" ]],
		   "paging": true,
		   "searching": true,
		   "columnDefs": [
			   { "orderable": true, "targets": [1, 2, 3, 4, 5, 6] },
			   { "orderable": false, "targets": [0, 7] }
		   ]
	   });
   });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var eventFilter = document.getElementById('eventFilter');
    if (!eventFilter) return;
	// remember original disabled state for per-row buttons so we don't re-enable template-disabled buttons
	document.querySelectorAll('.approve-btn, .present-btn, .view-bulk-btn').forEach(btn => {
		btn.dataset.origDisabled = btn.disabled ? 'true' : 'false';
	});

	function setActionsDisabled(disabled) {
		const ids = ['selectAllBtn','approveSelectedBtn','declineSelectedBtn','presentSelectedBtn','absentSelectedBtn'];
		ids.forEach(id => {
			const b = document.getElementById(id);
			if (b) b.disabled = disabled;
		});
		document.querySelectorAll('.approve-btn, .present-btn, .view-bulk-btn').forEach(btn => {
			const orig = btn.dataset.origDisabled === 'true';
			btn.disabled = disabled || orig;
		});
	}

	function applySelectedEventState(selectEl) {
		const opt = selectEl.options[selectEl.selectedIndex];
		const status = opt ? opt.dataset.status : undefined;
		if (status && status !== 'active') setActionsDisabled(true); else setActionsDisabled(false);
	}

	// apply initial state based on preselected option
	applySelectedEventState(eventFilter);

	eventFilter.addEventListener('change', function() {
		// immediately reflect state in UI (helps prevent actions before reload)
		applySelectedEventState(this);
		var val = this.value;
		var url = new URL(window.location.href);
		if (val) url.searchParams.set('event', val); else url.searchParams.delete('event');
		// Preserve other query params
		window.location.href = url.toString();
	});
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

	const csrftoken = getCookie('csrftoken');
	const selectAllBtn = document.getElementById('selectAllBtn');
	const approveBtn = document.getElementById('approveSelectedBtn');
	const declineBtn = document.getElementById('declineSelectedBtn');
	const presentBtn = document.getElementById('presentSelectedBtn');
	const absentBtn = document.getElementById('absentSelectedBtn');

	if (selectAllBtn) {
		selectAllBtn.dataset.all = 'false';
		selectAllBtn.addEventListener('click', function() {
			const all = document.querySelectorAll('.member-checkbox');
			const setTo = this.dataset.all !== 'true';
			all.forEach(cb => cb.checked = setTo);
			this.dataset.all = setTo ? 'true' : 'false';
			this.innerText = setTo ? 'Unselect All' : 'Select All';
		});
	}

	function getSelectedIds() {
		return Array.from(document.querySelectorAll('.member-checkbox:checked')).map(cb => cb.value).filter(Boolean);
	}

	function sendBulkAction(ids, action) {
		if (!ids.length) { alert('No members selected'); return Promise.resolve([]); }

		// Send a single request to the bulk member-registration endpoints so server adds one summary message
		const endpointFor = (act) => {
			if (act === 'approve') return '/hoo/MemberRegistrations/ApproveMultiple/';
			if (act === 'decline') return '/hoo/MemberRegistrations/DeclineMultiple/';
				if (act === 'present') return '/hoo/MemberRegistrations/PresentMultiple/';
				if (act === 'absent') return '/hoo/MemberRegistrations/AbsentMultiple/';
			return '';
		};

		const url = endpointFor(action);
		if (!url) return Promise.resolve([]);
		return fetch(url, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrftoken,
				'X-Requested-With': 'XMLHttpRequest'
			},
			body: JSON.stringify({ ids: ids })
		}).then(r => r.json().then(j => ({ ok: r.ok, json: j })).catch(() => ({ ok: r.ok }))).catch(() => ({ ok: false }));
	}


	function showAlert(type, text) {
		const container = document.querySelector('.card.shadow') || document.body;
		const div = document.createElement('div');
		let cls = 'alert alert-info';
		if (type === 'success') cls = 'alert alert-success';
		if (type === 'warning') cls = 'alert alert-warning';
		if (type === 'danger' || type === 'error') cls = 'alert alert-danger';
		div.className = cls + ' alert-dismissible fade show';
		div.role = 'alert';
		div.innerHTML = `<strong>${text}</strong>`;
		container.parentNode.insertBefore(div, container);
		setTimeout(() => {
			div.classList.remove('show');
			div.classList.add('fade');
			setTimeout(() => div.remove(), 300);
		}, 5000);
	}

	if (approveBtn) approveBtn.addEventListener('click', function() {
		const ids = getSelectedIds();
		if (!ids.length) { alert('No members selected'); return; }
		const btn = this; btn.disabled = true;
		sendBulkAction(ids, 'approve').then(results => {
			btn.disabled = false;
			// server-side messages will be shown after reload
			window.location.reload();
		}).catch(err => { btn.disabled = false; console.error(err); alert('Error during bulk approve'); });
	});

	if (declineBtn) declineBtn.addEventListener('click', function() {
		const ids = getSelectedIds();
		if (!ids.length) { alert('No members selected'); return; }
		const btn = this; btn.disabled = true;
		sendBulkAction(ids, 'decline').then(results => {
			btn.disabled = false;
			// server-side messages will be shown after reload
			window.location.reload();
		}).catch(err => { btn.disabled = false; console.error(err); alert('Error during bulk decline'); });
	});

	if (presentBtn) presentBtn.addEventListener('click', function() {
		const ids = getSelectedIds();
		if (!ids.length) { alert('No members selected'); return; }
		const btn = this; btn.disabled = true;
		sendBulkAction(ids, 'present').then(results => {
			btn.disabled = false;
			window.location.reload();
		}).catch(err => { btn.disabled = false; console.error(err); alert('Error during marking present'); });
	});

	if (absentBtn) absentBtn.addEventListener('click', function() {
		const ids = getSelectedIds();
		if (!ids.length) { alert('No members selected'); return; }
		const btn = this; btn.disabled = true;
		sendBulkAction(ids, 'absent').then(results => {
			btn.disabled = false;
			window.location.reload();
		}).catch(err => { btn.disabled = false; console.error(err); alert('Error during marking absent'); });
	});
});
</script>

<!-- Inline details section (hidden until a member is selected) -->
<div id="bulkDetailsSection" class="card shadow mb-4 d-none">
	<div class="card-body">
			<div class="d-sm-flex align-items-center justify-content-between mb-4">
				<h3 class="h5 mb-0 text-gray-800">Bulk Registrations for <b><span id="bulkOwnerName"></span></b></h3>
				<div>
					<button class="btn btn-primary me-2" id="bulkSelectAllBtn">Select All</button>
					<button class="btn btn-success me-2" id="bulkApproveBtn">Approve Selected</button>
					<button class="btn btn-danger me-2" id="bulkDeclineBtn">Decline Selected</button>
					<button class="btn btn-success me-2" id="bulkPresentBtn">Mark Present</button>
					<button class="btn btn-danger me-2" id="bulkAbsentBtn">Mark Absent</button>
					<button class="btn btn-secondary" id="closeBulkDetails">Back</button>
				</div>
			</div>
		<div class="table-responsive">
			<table class="table table-sm table-bordered text-center text-uppercase" id="bulkDetailsTable" width="100%" cellspacing="0">
				<thead>
					<tr>
						<th class="text-center"></th>
						<th>Last Name</th>
						<th>First Name</th>
						<th>Attending As</th>
					</tr>
				</thead>
				<tbody id="bulkDetailsTbody"></tbody>
			</table>
		</div>
	</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
	// View bulk-button handler (populate inline table)
	document.querySelectorAll('.view-bulk-btn').forEach(btn => {
			btn.addEventListener('click', function() {
				if (this.disabled) return; // ignore clicks when disabled
				const memberId = this.dataset.memberId;
				if (!memberId) return;
				// prefer explicit event id on the button, fallback to the row's data-event-id
				const eventId = this.dataset.eventId || (this.closest && this.closest('tr') ? this.closest('tr').dataset.eventId : null);
				fetch(`/hoo/MemberRegistrations/Get/${memberId}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
				.then(r => r.json())
				.then(data => {
					let rows = data.bulk_regs || [];
					const ownerName = data.member_name || '';
					// Filter by clicked row's event id (if provided) and only include active events when provided by backend
					if (eventId) {
						rows = rows.filter(r => {
							if (r.event_id === undefined) return false;
							if (String(r.event_id) !== String(eventId)) return false;
							if (r.event_status !== undefined && r.event_status !== 'active') return false;
							return true;
						});
					} else {
						// If no eventId supplied, still filter out non-active events if backend included status
						rows = rows.filter(r => (r.event_status === undefined) || (r.event_status === 'active'));
					}
					document.getElementById('bulkOwnerName').innerText = ownerName;

					const tbody = document.getElementById('bulkDetailsTbody');
					tbody.innerHTML = '';
					if (rows.length === 0) {
						tbody.innerHTML = '<tr><td colspan="4" class="text-center">No bulk registrations found for this member.</td></tr>';
					} else {
						rows.forEach(r => {
							const tr = document.createElement('tr');
							// include checkbox in first column; value uses r.id when available
							const rid = r.id !== undefined ? r.id : '';
							tr.innerHTML = `<td><input type="checkbox" class="bulk-row-checkbox" value="${rid}"></td><td>${r.last_name}</td><td>${r.first_name}</td><td>${r.attending_as || ''}</td>`;
							tbody.appendChild(tr);
						});
							// wire up individual checkbox change to update select-all-button state
							const selectAllBtn = document.getElementById('bulkSelectAllBtn');
							const checkboxes = tbody.querySelectorAll('.bulk-row-checkbox');
							checkboxes.forEach(cb => cb.addEventListener('change', function() {
								const all = tbody.querySelectorAll('.bulk-row-checkbox');
								const checked = tbody.querySelectorAll('.bulk-row-checkbox:checked');
								if (selectAllBtn) {
									if (checked.length === all.length && all.length > 0) {
										selectAllBtn.innerText = 'Unselect All';
										selectAllBtn.dataset.all = 'true';
									} else {
										selectAllBtn.innerText = 'Select All';
										selectAllBtn.dataset.all = 'false';
									}
								}
							}));
					}

					// show the details section and scroll to it
					document.getElementById('bulkDetailsSection').classList.remove('d-none');
					document.getElementById('bulkDetailsSection').scrollIntoView({ behavior: 'smooth' });

					// select-all button handler (toggles all row checkboxes)
					const selectAllBtn = document.getElementById('bulkSelectAllBtn');
					if (selectAllBtn) {
						selectAllBtn.dataset.all = 'false';
						selectAllBtn.innerText = 'Select All';
						selectAllBtn.addEventListener('click', function() {
							const all = document.querySelectorAll('#bulkDetailsTbody .bulk-row-checkbox');
							const setTo = this.dataset.all !== 'true';
							all.forEach(cb => cb.checked = setTo);
							this.dataset.all = setTo ? 'true' : 'false';
							this.innerText = setTo ? 'Unselect All' : 'Select All';
						});
					}

					// helper: get selected ids
					function getSelectedIds() {
						return Array.from(document.querySelectorAll('#bulkDetailsTbody .bulk-row-checkbox:checked')).map(cb => cb.value).filter(Boolean);
					}

					// bulk approve/decline
					const bulkApproveBtn = document.getElementById('bulkApproveBtn');
					const bulkDeclineBtn = document.getElementById('bulkDeclineBtn');
					if (bulkApproveBtn) bulkApproveBtn.addEventListener('click', function() {
						const ids = getSelectedIds();
						if (!ids.length) { alert('No rows selected'); return; }
						// Prefer sending a single request for multiple approvals
						const btn = this;
						btn.disabled = true;
						fetch('/hoo/MemberRegistrations/BulkApproveMultiple/', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'X-CSRFToken': csrftoken,
								'X-Requested-With': 'XMLHttpRequest'
							},
							body: JSON.stringify({ ids: ids })
						})
						.then(r => r.json())
						.then(response => {
							btn.disabled = false;
							// Expecting a success flag or per-id result; reload to reflect server-side changes
							if (response && (response.success === true || response.success)) {
								window.location.reload();
							} else if (response && response.success === false) {
								alert('Some approvals failed');
								window.location.reload();
							} else {
								// If backend returned detailed results, be conservative and reload
								window.location.reload();
							}
						})
						.catch(err => { btn.disabled = false; console.error(err); alert('Error during bulk approve'); });
					});

					if (bulkDeclineBtn) bulkDeclineBtn.addEventListener('click', function() {
						const ids = getSelectedIds();
						if (!ids.length) { alert('No rows selected'); return; }
						const btn = this;
						btn.disabled = true;
						// Backend currently exposes singular BulkDecline per id; keep using parallel requests
						Promise.all(ids.map(id => fetch(`/hoo/MemberRegistrations/BulkDecline/${id}/`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'X-CSRFToken': csrftoken,
								'X-Requested-With': 'XMLHttpRequest'
							},
							body: JSON.stringify({})
						}).then(r => r.json())))
						.then(results => {
							btn.disabled = false;
							if (results.every(r => r && r.success)) window.location.reload(); else { alert('Some declines failed'); window.location.reload(); }
						})
						.catch(err => { btn.disabled = false; console.error(err); alert('Error during bulk decline'); });
					});

					// bulk present/absent
					const bulkPresentBtn = document.getElementById('bulkPresentBtn');
					const bulkAbsentBtn = document.getElementById('bulkAbsentBtn');
					if (bulkPresentBtn) bulkPresentBtn.addEventListener('click', function() {
						const ids = getSelectedIds();
						if (!ids.length) { alert('No rows selected'); return; }
						Promise.all(ids.map(id => fetch('/hoo/attendance/toggle/', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'X-CSRFToken': csrftoken,
								'X-Requested-With': 'XMLHttpRequest'
							},
							body: JSON.stringify({ id: id, present: true })
						}).then(r => r.json())))
						.then(results => {
							if (results.every(r => r && r.success)) window.location.reload(); else { alert('Some attendance updates failed'); window.location.reload(); }
						})
						.catch(err => { console.error(err); alert('Error during bulk present'); });
					});

					if (bulkAbsentBtn) bulkAbsentBtn.addEventListener('click', function() {
						const ids = getSelectedIds();
						if (!ids.length) { alert('No rows selected'); return; }
						Promise.all(ids.map(id => fetch('/hoo/attendance/toggle/', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'X-CSRFToken': csrftoken,
								'X-Requested-With': 'XMLHttpRequest'
							},
							body: JSON.stringify({ id: id, present: false })
						}).then(r => r.json())))
						.then(results => {
							if (results.every(r => r && r.success)) window.location.reload(); else { alert('Some attendance updates failed'); window.location.reload(); }
						})
						.catch(err => { console.error(err); alert('Error during bulk absent'); });
					});
				})
				.catch(err => {
					console.error('Error fetching bulk rows', err);
					const tbody = document.getElementById('bulkDetailsTbody');
					tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">Failed to load data.</td></tr>';
					document.getElementById('bulkDetailsSection').classList.remove('d-none');
					document.getElementById('bulkDetailsSection').scrollIntoView({ behavior: 'smooth' });
				});
		});
	});

	document.getElementById('closeBulkDetails').addEventListener('click', function() {
		document.getElementById('bulkDetailsSection').classList.add('d-none');
		document.getElementById('bulkDetailsTbody').innerHTML = '';
	});
    
	// Approve button handler: send POST to approve endpoint and update UI
	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

	const csrftoken = getCookie('csrftoken');

	// Approve / Decline toggle
	document.querySelectorAll('.approve-btn').forEach(btn => {
		btn.addEventListener('click', function() {
			const regId = this.dataset.id;
			if (!regId) return;
			const button = this;
			const isApproveAction = button.innerText.trim().toLowerCase() === 'approve';
			const url = isApproveAction ? `/hoo/MemberRegistrations/Approve/${regId}/` : `/hoo/MemberRegistrations/Decline/${regId}/`;

			fetch(url, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': csrftoken,
					'X-Requested-With': 'XMLHttpRequest'
				},
				body: JSON.stringify({})
			})
			.then(r => r.json())
			.then(data => {
				if (data && data.success) {
					// reload so server-side Django messages are shown
					window.location.reload();
				} else {
					console.error('Approve/Decline failed', data);
					alert('Failed to update approval');
				}
			})
			.catch(err => {
				console.error('Error updating approval', err);
				alert('Error updating approval');
			});
		});
	});

	// Present / Absent toggle â€” uses existing attendance toggle endpoint
	document.querySelectorAll('.present-btn').forEach(btn => {
		btn.addEventListener('click', function() {
			if (this.disabled) return; // ignore clicks when disabled (not approved)
			const regId = this.dataset.id;
			if (!regId) return;
			const button = this;
			const isPresent = button.innerText.trim().toLowerCase() === 'present';

			const url = isPresent ? `/hoo/MemberRegistrations/Present/${regId}/` : `/hoo/MemberRegistrations/Absent/${regId}/`;
			fetch(url, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': csrftoken,
					'X-Requested-With': 'XMLHttpRequest'
				},
				body: JSON.stringify({})
			})
			.then(r => r.json())
			.then(data => {
				if (data && data.success) {
					// reload to show server-side message
					window.location.reload();
				} else {
					console.error('Attendance toggle failed', data);
					alert('Failed to update attendance');
				}
			})
			.catch(err => {
				console.error('Error toggling attendance', err);
				alert('Error toggling attendance');
			});
		});
	});
});
</script>

{% endblock %}
