{% extends "includes/base.html" %}
{% load static %}
{% block content %}
{% include 'includes/messages.html' %}

<div class="card shadow mb-4">
   <div class="card-body">

	  <div class="col-sm-12">
		 <div class="d-sm-flex align-items-center justify-content-between mb-4">
			<a href="{% url 'hoo_home' %}" class="btn btn-secondary" title="Go Back">
				<i class="fas fa-arrow-left"></i>&nbsp;&nbsp; Back</a>
		 	 <div>
		 	   <h1 class="h3 mb-0 text-gray-800">Attendance List</h1>
		 	   {% if event %}
		 	      <div class="small text-primary">Event: <strong>{{ event.title }}</strong></div>
		 	   {% else %}
		 	      <div class="small text-muted">No active event</div>
		 	   {% endif %}
		 	 </div>
		 </div>
	  </div>
     
	  <div class="table-responsive">
		  <table class="table text-center text-uppercase table-bordered" id="attendanceTable" width="100%" cellspacing="0" >
			<thead>
			   <tr>
				  <th>Firstname</th>
				  <th>Lastname</th>
					<th>School</th>
					<th>Status</th>
					<th class="text-center">Action</th>
			   </tr>
			</thead>
			<tfoot>
			  <tr>
				 <th>Firstname</th>
				 <th>Lastname</th>
				  	  <th>School</th>
				  	  <th>Status</th>
				  	  <th class="text-center">Action</th>
			  </tr>
			</tfoot>
           
		   <tbody>
			{% for attendee in attendees %}
				<tr>
					<td>{{ attendee.first_name|upper }}</td>
					<td>{{ attendee.last_name|upper }}</td>
					<td>{{ attendee.school|upper }}</td>
						<td>
							{% if attendee.present is None %}
								<!-- no status yet -->
							{% elif attendee.present %}
								<span class="badge badge-success">Present</span>
							{% else %}
								<span class="badge badge-secondary">Absent</span>
							{% endif %}
						</td>
				   <td class="text-center">
					  <select class="form-control attendance-select" data-id="{{ attendee.id }}" style="width:140px;display:inline-block;">
						  <option value="" {% if attendee.present is None %}selected{% endif %}>Select</option>
						  <option value="present" {% if attendee.present %}selected{% endif %}>Present</option>
						  <option value="absent" {% if attendee.present is not None and not attendee.present %}selected{% endif %}>Absent</option>
					  </select>
				   </td>
				</tr>
			{% empty %}
				<tr>
					<td colspan="5" class="text-center">No attendees found.</td>
				</tr>
			{% endfor %}
		   </tbody>

		 </table>
	  </div>
   </div>
 </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
   $('#attendanceTable').DataTable({
	   "order": [[ 1, "asc" ]],
	   "paging": true,
	   "searching": true,
	   "columnDefs": [
		   { "orderable": true, "targets": [0, 1, 2, 3, 4] }
	   ]
   });
	// CSRF helper (reads csrftoken from cookie)
	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

	const csrftoken = getCookie('csrftoken');

	// Handle select changes (Present/Absent)
	document.querySelectorAll('.attendance-select').forEach(select => {
		select.addEventListener('change', function (e) {
			const attendeeId = this.dataset.id;
			const newValue = this.value; // 'present' or 'absent'
			const present = newValue === 'present';
			const previousValue = this.getAttribute('data-prev') || (present ? 'absent' : 'present');

			// Optimistically send POST to server
			fetch('/hoo/attendance/toggle/', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': csrftoken,
					'X-Requested-With': 'XMLHttpRequest'
				},
				body: JSON.stringify({ id: attendeeId, present: present })
			})
			.then(response => {
				if (!response.ok) {
					// revert select on failure
					select.value = previousValue;
					return response.text().then(text => { throw new Error(text || 'Server error'); });
				}
				return response.json().catch(() => ({}));
			})
			.then(data => {
				// update data-prev to current value for future reverts
				select.setAttribute('data-prev', newValue);
			})
			.catch(err => {
				console.error('Error updating attendance:', err);
				alert('Could not update attendance. Please try again.');
			});
		});
		// initialize data-prev attribute from current selection
		select.setAttribute('data-prev', select.value);
	});
});
</script>

{% endblock %}

