{% extends "includes/base.html" %}
{% load static %}
{% block content %}
{% include 'includes/messages.html' %}

<div class="card shadow mb-4">
   <div class="card-body">
        <div class="col-sm-12">
            <div class="d-sm-flex align-items-center mb-4">
                <a href="{% url 'hoo_home' %}" class="btn btn-secondary" title="Go Back">
                     <i class="fas fa-arrow-left"></i>&nbsp;&nbsp; Back</a>
                 <h1 class="h3 mb-0 text-gray-800 mx-auto">Membership Registration Approval</h1>
            </div>

            <!-- Bulk action controls (right-aligned) -->
            <div class="mb-3 d-flex justify-content-end">
                <div class="btn-group" role="group" aria-label="Bulk actions">
                    <button id="selectAllBtn" class="btn btn-primary btn-sm">Select All</button>
                    <button id="approveSelectedBtn" class="btn btn-success btn-sm">Approve Selected</button>
                    <button id="declineSelectedBtn" class="btn btn-danger btn-sm">Decline Selected</button>
                </div>
            </div>
        </div>
     
       <div class="table-responsive">
              <table class="table text-center text-uppercase table-bordered" id="dataTable" width="100%" cellspacing="0">
             <thead>
                <tr>
                         <th></th>
                   <th>Firstname</th>
                   <th>Lastname</th>
                   <th>School</th>
                   <th>Position</th>
                             <th>MembershipType</th>
                             <th>Type</th>
                   <th>Price</th>
                   <th>Proof of Payment</th>
                   <th>Status</th>
                   <th class="text-center">Action</th>
                </tr>
             </thead>
                 <tfoot>
                    <tr>
                        <th></th>
                        <th>Firstname</th>
                        <th>Lastname</th>
                        <th>School</th>
                        <th>Position</th>
                                <th>MembershipType</th>
                                <th>Type</th>
                        <th>Price</th>
                        <th>Proof of Payment</th>
                        <th>Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                 </tfoot>
            <tbody>
                {% for m in members %}
                    <tr>
                                <td class="align-middle"><input type="checkbox" class="member-checkbox" value="{{ m.id }}"></td>
                        <td>{{ m.admin.first_name|upper }}</td>
                        <td>{{ m.admin.last_name|upper }}</td>
                        <td>{{ m.organization.name }}</td>
                        <td>{{ m.position|upper }}</td>
                        <td>{{ m.membershiptype.name|upper }}</td>
                        <td>
                            {% if m.latest_membertype_id == 1 %}
                                <span class="badge badge-primary">New</span>
                            {% elif m.latest_membertype_id == 2 %}
                                <span class="badge badge-info">Renew</span>
                            {% else %}
                                <span class="badge badge-secondary">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if m.membershiptype.price %}
                                {{ m.membershiptype.price }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if m.proof_of_payment %}
                                <a href="{{ m.proof_of_payment.url }}" target="_blank">
                                    <img src="{{ m.proof_of_payment.url }}" alt="Proof of Payment" style="height:50px; width:auto;">
                                </a>
                            {% else %}
                                <span class="text-muted">No Payment</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if m.status == "Approved" or m.status == "APPROVED" %}
                                <span class="badge badge-success">Approved</span>
                            {% elif m.status == "Declined" or m.status == "REJECTED" %}
                                <span class="badge badge-danger">Declined</span>
                            {% elif m.status == "Pending" or m.status == "PENDING" %}
                                <span class="badge badge-warning">Pending</span>
                            {% else %}
                                <span class="badge badge-secondary">{{ m.status }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center align-items-center">
                                <!-- View Button -->
                                <button class="btn btn-sm btn-info view-btn mr-1" 
                                        data-toggle="modal" 
                                        data-target="#viewModal{{ m.id }}" 
                                        title="View Member Info">
                                    <i class="fas fa-eye"></i>
                                </button>

                                <!-- Approve Button -->
                                <form method="POST" style="display:inline;" class="mr-1">
                                    {% csrf_token %}
                                    <input type="hidden" name="member_id" value="{{ m.id }}">
                                    <button type="submit" name="action" value="approve" 
                                            class="btn btn-sm btn-success" data-toggle="tooltip" title="Approve" {% if m.status == "Approved" or m.status == "APPROVED" %}disabled{% endif %}>
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>

                                <!-- Decline Button -->
                                <form method="POST" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="member_id" value="{{ m.id }}">
                                    <button type="submit" name="action" value="decline" 
                                            class="btn btn-sm btn-danger" data-toggle="tooltip" title="Decline">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>

                    <!-- View Modal -->
                    <div class="modal fade" id="viewModal{{ m.id }}" tabindex="-1" role="dialog" aria-labelledby="viewModalLabel{{ m.id }}" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title" id="viewModalLabel{{ m.id }}">Member Details</h5>
                                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Name:</strong> {{ m.admin.first_name }} {{ m.admin.last_name }}</p>
                                    <p><strong>Email:</strong> {{ m.admin.email }}</p>
                                    <p><strong>School:</strong> {{ m.organization.name }}</p>
                                    <p><strong>Position:</strong> {{ m.position }}</p>
                                    <p><strong>Membership Type:</strong> {{ m.membershiptype.name }}</p>
                                    <p><strong>Status:</strong> {{ m.status }}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                <tr>
                    <td colspan="10">No members found.</td>
                </tr>
                {% endfor %}
            </tbody>
          </table>
       </div>
    </div>
 </div>
</div>

<script>
   $(document).ready(function() {
           $('#dataTable').DataTable({
           "order": [[ 5, "desc" ]],
           "paging": true,
           "searching": true,
           "columnDefs": [
               { "orderable": true, "targets": [0,1,2,3,4,5,6,7,8,9,10] },
               { "orderable": false, "targets": [0,10] }
           ]
       });
   });
</script>

<script>
// Select-all and bulk approve/decline behavior
document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const approveBtn = document.getElementById('approveSelectedBtn');
    const declineBtn = document.getElementById('declineSelectedBtn');
    const membershipUrl = "{% url 'membership_approval' %}";

    if (selectAllBtn) {
        selectAllBtn.dataset.all = 'false';
        selectAllBtn.addEventListener('click', function() {
            const all = document.querySelectorAll('.member-checkbox');
            const setTo = this.dataset.all !== 'true';
            all.forEach(cb => cb.checked = setTo);
            this.dataset.all = setTo ? 'true' : 'false';
            this.innerText = setTo ? 'Unselect All' : 'Select All';
        });
    }

    function getSelectedIds() {
        return Array.from(document.querySelectorAll('.member-checkbox:checked')).map(cb => cb.value).filter(Boolean);
    }

    function sendBulkAction(ids, action) {
        if (!ids.length) { alert('No members selected'); return Promise.resolve({ ok: false }); }
        const url = membershipUrl; // POST JSON { ids: [...], action: 'approve'|'decline' }
        return fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ ids: ids, action: action })
        }).then(r => r.json().then(j => ({ ok: r.ok, json: j })).catch(() => ({ ok: r.ok }))).catch(() => ({ ok: false }));
    }

    function showAlert(type, text) {
        const container = document.querySelector('.card.shadow') || document.body;
        const div = document.createElement('div');
        let cls = 'alert alert-info';
        if (type === 'success') cls = 'alert alert-success';
        if (type === 'warning') cls = 'alert alert-warning';
        if (type === 'danger' || type === 'error') cls = 'alert alert-danger';
        div.className = cls + ' alert-dismissible fade show';
        div.role = 'alert';
        div.innerHTML = `<strong>${text}</strong>`;
        container.parentNode.insertBefore(div, container);
        // auto-hide after 5 seconds
        setTimeout(() => {
            div.classList.remove('show');
            div.classList.add('fade');
            setTimeout(() => div.remove(), 300);
        }, 5000);
    }

    if (approveBtn) approveBtn.addEventListener('click', function() {
        const ids = getSelectedIds();
        if (!ids.length) { alert('No members selected'); return; }
        const btn = this; btn.disabled = true;
        sendBulkAction(ids, 'approve').then(resp => {
            btn.disabled = false;
            if (resp && resp.ok) {
                // server-side messages will be shown after reload
                window.location.reload();
            } else {
                console.error('Bulk approve error', resp && resp.json ? resp.json : resp);
                alert('Error during bulk approve');
            }
        }).catch(err => { btn.disabled = false; console.error(err); alert('Error during bulk approve'); });
    });

    if (declineBtn) declineBtn.addEventListener('click', function() {
        const ids = getSelectedIds();
        if (!ids.length) { alert('No members selected'); return; }
        const btn = this; btn.disabled = true;
        sendBulkAction(ids, 'decline').then(resp => {
            btn.disabled = false;
            if (resp && resp.ok) {
                window.location.reload();
            } else {
                console.error('Bulk decline error', resp && resp.json ? resp.json : resp);
                alert('Error during bulk decline');
            }
        }).catch(err => { btn.disabled = false; console.error(err); alert('Error during bulk decline'); });
    });
});
</script>
{% endblock %}
