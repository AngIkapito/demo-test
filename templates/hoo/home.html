{% extends "includes/base.html" %}
{% load static %}
{% block content %}  
<!-- DITO KA MAS START MAGLAGAY NG LAMAN NG BODY -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- Main Content -->
    {% comment %} <div class="col-md-9 col-lg-10 p-4"> {% endcomment %}
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Welcome, {{user.username}}! </h2>
        <div>
          <button class="btn btn-primary" data-toggle="modal" data-target="#generateReportModal">Generate Report</button>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="row mb-4">
        <div class="col-12 col-md-4 mb-3">
          <div class="card text-bg-light shadow h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted">Total Registered Members</h6>
                <h4 class="text-success">{{members.count}} Active</h4>
              </div>
              <i class="fas fa-users fa-2x text-secondary"></i>
            </div>
          </div>
        </div>
       
        <div class="col-12 col-md-4 mb-3">
          <div class="card text-bg-light shadow h-100">
            <a href="{% url 'viewall_event' %}">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted">Total Events Conducted</h6>
                <h4 class="text-primary">{{events.count}}</h4>
              </div>
              <i class="fas fa-calendar-check fa-2x text-secondary"></i>
            </div>
             </a>
          </div>
        </div>

        <div class="col-12 col-md-4 mb-3">
          <div class="card text-bg-light shadow h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted">Reports Generated</h6>
                <h4 class="text-warning">17</h4>
              </div>
              <i class="fas fa-file-alt fa-2x text-secondary"></i>
            </div>
          </div>
        </div>
      </div>  

      <style>
        /* Highlighted calendar cell when selected from legend */
        #calendar td.legend-selected{ background-color: #ffc107 !important; color: #212529 !important; border-radius: 0.25rem; }
        .legend-item{ cursor: pointer; text-decoration: none; color: inherit; }
        .legend-item:hover{ text-decoration: underline; }
        /* Make date cells show pointer and a subtle hover effect */
        #calendar td[data-date]{ cursor: pointer; transition: background-color .12s ease; }
        #calendar td[data-date]:hover{ background-color: rgba(0,0,0,0.03); }
        /* Make all date boxes the same size */
        #calendar table{ table-layout: fixed; width:100%; }
        #calendar table td{ padding: .4rem; vertical-align: top; }
        #calendar td.calendar-cell{ height:92px; }
        #calendar td.calendar-cell .cell-inner{ display:flex; flex-direction:column; justify-content:space-between; height:100%; }
        /* Modal banner/info spacing */
        #eventModalBanner{ padding-right: .75rem; }
        #eventModalBanner img{ width:100%; height:auto; object-fit:cover; border-radius: .25rem; }
        #eventModalInfo{ text-align: left; display:flex; flex-direction:column; justify-content:center; }
        #eventModalInfo h5{ margin-top:0; margin-bottom:.5rem; }
      </style>

      <!-- Real-time Registration Overview -->
      <!-- Real-time Registration Overview -->
      <div class="row">
        <!-- Left column: stacked cards -->
        <div class="col-lg-8">
          <!-- Real-time Registration Overview -->
          <div class="card mb-4 shadow">
            <div class="card-header bg-primary text-white">
              Real-time Registration Overview
            </div>
            <div class="card-body">
              {% if event %}
                <p><strong>Current Event:</strong> {{ event.title }}</p>
                <div class="progress mb-3">
                  <div class="progress-bar bg-success" role="progressbar"
                      style="width: {{ progress_percent }}%;"
                      aria-valuenow="{{ registered_count }}" 
                      aria-valuemin="0" 
                      aria-valuemax="{{ event.max_attendees }}">
                    {{ registered_count }}/{{ event.max_attendees }} Registered
                  </div>
                </div>
                <p class="text-muted">{{ available_slots }} slots remaining</p>
                <!-- ApexCharts container for registration overview -->
                <div id="chart" class="mt-3" style="max-width:100%; height:360px;"></div>
              {% else %}
                <p>No active events at the moment.</p>
              {% endif %}
            </div>
          </div>

          <!-- Past Events Summary -->
          <div class="card mb-4 shadow">
            <div class="card-header bg-secondary shadow text-white">
              Past Events Summary
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Event</th>
                      <th>Date</th>
                      <th>Registered</th>
                      <th>Attended</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>AI Forum 2025</td>
                      <td>April 18, 2025</td>
                      <td>180</td>
                      <td>172</td>
                      <td><a href="#" class="btn btn-sm btn-outline-info">View</a></td>
                    </tr>
                    <tr>
                      <td>Cybersecurity Webinar</td>
                      <td>March 15, 2025</td>
                      <td>210</td>
                      <td>198</td>
                      <td><a href="#" class="btn btn-sm btn-outline-info">View</a></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Reports Section -->
          <div class="card shadow mb-4">
            <div class="card-header bg-dark text-white">
              Reports
            </div>
            <div class="card-body">
              <p>You can generate and download the latest reports on membership, event attendance, and registrations.</p>
              <button class="btn btn-outline-primary">Download PDF</button>
              <button class="btn btn-outline-success">Export to Excel</button>
            </div>
          </div>
          <!-- Member Rankings (profile-style, no data) -->
          <style>
            .ranking-card .member-row{display:flex;align-items:center;gap:.75rem;padding:.6rem 0;border-bottom:0}
            .ranking-card .avatar{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,#eee,#ddd);flex:0 0 46px}
            .ranking-card .profile-placeholder{flex:1;min-width:0}
            .ranking-card .name-placeholder{height:14px;width:45%;background:#f1f3f5;border-radius:4px;margin-bottom:6px}
            .ranking-card .org-placeholder{height:12px;width:35%;background:#f1f3f5;border-radius:4px}
            .ranking-card .rank-badge{min-width:46px;text-align:center;background:transparent;color:#495057;font-weight:700}
          </style>
          <div class="card shadow mb-4 ranking-card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <div>
                  <strong>Member Rankings</strong>
                  <div class="small text-muted">Top contributors / competitors (preview)</div>
                </div>
                <form id="syFilterForm" method="get" class="d-flex align-items-center">
                  <select name="school_year" onchange="document.getElementById('syFilterForm').submit()" class="form-select form-select-sm">
                    <option value="">All years</option>
                    {% for sy in school_years %}
                      <option value="{{ sy.id }}" {% if selected_school_year and selected_school_year == sy.id %}selected{% endif %}>{{ sy.sy_start.year }}-{{ sy.sy_end.year }}</option>
                    {% endfor %}
                  </select>
                </form>
              </div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="small text-muted">Members with consecutive attendance streaks</div>
                <div class="small">
                  <span class="badge bg-success">3x: {{ streak_counts.three }}</span>
                  <span class="badge bg-primary">5x: {{ streak_counts.five }}</span>
                  <span class="badge bg-warning text-dark">10x: {{ streak_counts.ten }}</span>
                </div>
              </div>
              <div class="d-flex flex-column">
                {% for r in member_rankings %}
                <div class="member-row py-2">
                  <div class="org-logo" aria-hidden="true" style="flex:0 0 56px;">
                    {% if r.member and r.member.organization and r.member.organization.logo %}
                      <img src="{{ r.member.organization.logo.url }}" class="rounded" style="width:56px;height:46px;object-fit:cover" alt="org-logo">
                    {% endif %}
                  </div>
                  <div class="avatar" aria-hidden="true">
                    {% if r.member and r.member.admin and r.member.admin.profile_pic %}
                      <img src="{{ r.member.admin.profile_pic.url }}" class="rounded-circle" style="width:46px;height:46px;object-fit:cover" alt="avatar">
                    {% endif %}
                  </div>
                  <div class="profile-placeholder">
                    <div><strong>{{ r.member_name }}</strong></div>
                    <div class="small text-muted">{{ r.organization }}</div>
                    <div class="small text-muted">Joined {{ r.total_joined }} events</div>
                  </div>
                  <div class="rank-badge">
                    <span class="badge {% if r.longest_streak >= 10 %}bg-warning text-dark{% elif r.longest_streak >= 5 %}bg-primary{% elif r.longest_streak >= 3 %}bg-success{% else %}bg-secondary{% endif %}">{{ r.longest_streak }}x</span>
                  </div>
                </div>
                {% empty %}
                <div class="text-muted">No member attendance data.</div>
                {% endfor %}
              </div>
            </div>
          </div>
          <!-- Interested IT Topics Pie Chart -->
          
        </div>

        <!-- Right column: calendar -->
        <div class="col-lg-4">
          <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
              Calendar
            </div>
            <div class="card-body">
              <div id="calendar" class="text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <button id="prevMonth" class="btn btn-sm btn-outline-secondary">&lt;</button>
                  <h5 id="calendarTitle" class="mb-0"></h5>
                  <button id="nextMonth" class="btn btn-sm btn-outline-secondary">&gt;</button>
                </div>
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th class="text-center">Sun</th>
                      <th class="text-center">Mon</th>
                      <th class="text-center">Tue</th>
                      <th class="text-center">Wed</th>
                      <th class="text-center">Thu</th>
                      <th class="text-center">Fri</th>
                      <th class="text-center">Sat</th>
                    </tr>
                  </thead>
                  <tbody id="calendarBody"></tbody>
                </table>
                <div id="calendarLegend" class="mt-3 small">
                  <!-- Legend populated by JS: shows event date and title for visible month -->
                </div>
              </div>
            </div>
          </div>
          <!-- Interested IT Topics Pie Chart (moved under calendar) -->
          <div class="card shadow mb-4 mt-3">
            <div class="card-header bg-info text-white">Interested IT Topics</div>
            <div class="card-body">
              <div id="topicsPie" style="max-width:420px;margin:0 auto;"></div>
            </div>
          </div>
        </div>
            
        <!-- Event details modal -->
        <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-4" id="eventModalBanner">
                    <!-- banner image -->
                  </div>
                  <div class="col-md-8" id="eventModalInfo">
                    <!-- event info populated by JS -->
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Generate Report Modal -->
      <div class="modal fade" id="generateReportModal" tabindex="-1" role="dialog" aria-labelledby="generateReportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="generateReportModalLabel">Generate Report</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
              <form id="generateReportForm" method="post" action="{% url 'hoo_generate_report' %}">
                {% csrf_token %}
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="syStartSelect">School Year Start</label>
                      <select id="syStartSelect" name="sy_start" class="form-control">
                        {% for sy in school_years %}
                          {% if sy.status %}
                            <option value="{{ sy.id }}" selected>{{ sy.sy_start.year }}</option>
                          {% endif %}
                        {% endfor %}
                        {% for sy in school_years %}
                          {% if not sy.status %}
                            <option value="{{ sy.id }}">{{ sy.sy_start.year }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="syEndSelect">School Year End</label>
                      <select id="syEndSelect" name="sy_end" class="form-control">
                        {% for sy in school_years %}
                          {% if sy.status %}
                            <option value="{{ sy.id }}" selected>{{ sy.sy_end.year }}</option>
                          {% endif %}
                        {% endfor %}
                        {% for sy in school_years %}
                          {% if not sy.status %}
                            <option value="{{ sy.id }}">{{ sy.sy_end.year }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Download</button>
            </div>
              </form>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  window.onload = function () {
    var chart = new CanvasJS.Chart("chartContainer",{
      animationEnabled: true,
      theme: "light2",
      title:{
        text: "Python Area Chart"
      },
      data: [{        
        type: "area",
        indexLabelFontSize: 16,
        dataPoints: {{ datapoints|safe }}
      }]
    });
    chart.render();
  }
</script>    
{{ events_json|json_script:"events-data" }}

<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<!-- ApexCharts registration overview initialization -->
<script>
  (function(){
    try{
      var options = {
        series: {{ chart_series_json|safe }},
        chart: {
          type: 'bar',
          height: 350
        },
        plotOptions: {
          bar: {
            horizontal: false,
            columnWidth: '55%',
            borderRadius: 5,
            borderRadiusApplication: 'end'
          },
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          show: true,
          width: 2,
          colors: ['transparent']
        },
        xaxis: {
          categories: {{ chart_categories_json|safe }},
        },
        yaxis: {
          title: {
            text: 'Count'
          }
        },
        fill: {
          opacity: 1
        },
        tooltip: {
          y: {
            formatter: function (val) {
              return String(val);
            }
          }
        }
      };

      var chart = new ApexCharts(document.querySelector("#chart"), options);
      chart.render();
    }catch(e){ console.error('ApexCharts init failed', e); }
  })();
</script>

<!-- Topics pie chart -->
<script>
  (function(){
    try{
      var options = {
        series: {{ topics_pie_series_json|safe }},
        chart: { width: 380, type: 'pie' },
        labels: {{ topics_pie_labels_json|safe }},
        responsive: [{
          breakpoint: 480,
          options: { chart: { width: 200 }, legend: { position: 'bottom' } }
        }]
      };
      var chart = new ApexCharts(document.querySelector("#topicsPie"), options);
      chart.render();
    }catch(e){ console.error('Topics pie init failed', e); }
  })();
</script>

<script>
  (function(){
    // Simple calendar renderer: prev/next month + highlight today
    const calTitle = document.getElementById('calendarTitle');
    const calBody = document.getElementById('calendarBody');
    const prevBtn = document.getElementById('prevMonth');
    const nextBtn = document.getElementById('nextMonth');
    let today = new Date();
    let currMonth = today.getMonth();
    let currYear = today.getFullYear();
    let activeEventModal = null;

    // Parse events provided by the view and map them by YYYY-MM-DD
    const rawEvents = document.getElementById('events-data') ? JSON.parse(document.getElementById('events-data').textContent) : [];
    const eventMap = {};
    function parseDateOnlyString(s){
      // s expected in 'YYYY-MM-DD' format
      if(!s) return null;
      const parts = s.split('-');
      if(parts.length >= 3){
        const y = parseInt(parts[0],10);
        const m = parseInt(parts[1],10) - 1;
        const d = parseInt(parts[2],10);
        return new Date(y,m,d);
      }
      const fallback = new Date(s);
      return isNaN(fallback) ? null : fallback;
    }
    rawEvents.forEach(ev => {
      if(!ev || !ev.date) return;
      const d = parseDateOnlyString(ev.date);
      if(!d) return;
      const key = d.toISOString().slice(0,10);
      if(!eventMap[key]) eventMap[key] = [];
      eventMap[key].push(ev);
    });

    // delegate click on event dots to open modal
    document.addEventListener('click', function(e){
      const dot = e.target.closest && e.target.closest('.event-dot');
      if(dot){
        const evId = dot.dataset.eventId;
        if(evId){
          e.stopPropagation();
          openEventModal(evId);
        }
      }
    });

    // Clicking the date cell should open the modal for the first event on that date
    if(calBody){
      calBody.addEventListener('click', function(e){
        const td = e.target.closest && e.target.closest('td[data-date]');
        if(!td) return;
        const dateKey = td.dataset.date;
        if(!dateKey) return;
        // highlight the selected date
        highlightDate(dateKey);
        // if there are events on this date, open the modal for the first one
        const evs = eventMap[dateKey];
        if(evs && evs.length){
          openEventModal(evs[0].id);
        }
      });
    }

    // If data-bs-dismiss attributes are not wired, ensure Close/X buttons hide the modal
    document.addEventListener('click', function(e){
      const dismiss = e.target.closest && e.target.closest('[data-bs-dismiss="modal"]');
      if(dismiss && activeEventModal){
        try{ activeEventModal.hide(); }catch(err){}
        e.preventDefault();
      }
    });

    // Allow Escape key to close the active modal
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape' && activeEventModal){
        try{ activeEventModal.hide(); }catch(err){}
      }
    });

    function renderCalendar(month, year){
      if(!calTitle || !calBody) return;
      calTitle.textContent = new Date(year, month).toLocaleString(undefined, { month: 'long', year: 'numeric' });
      calBody.innerHTML = '';
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let date = 1;
      for(let i=0;i<6;i++){
        const row = document.createElement('tr');
        for(let j=0;j<7;j++){
          const cell = document.createElement('td');
          cell.className = 'align-middle text-center';
          if(i===0 && j<firstDay){
            cell.innerHTML = '';
          } else if(date>daysInMonth){
            cell.innerHTML = '';
          } else {
            // Build ISO key for this cell's date
            const cellDate = new Date(year, month, date);
            const cellKey = cellDate.toISOString().slice(0,10);

            // Render the date number (highlight today)
            let dateHtml = '';
            if(date === today.getDate() && month === today.getMonth() && year === today.getFullYear()){
              dateHtml = '<div class="badge bg-primary text-white rounded-pill px-2">'+date+'</div>';
            } else {
              dateHtml = '<div>'+date+'</div>';
            }

            // If events exist on this date, append a small marker and tooltip
            let markerHtml = '';
            if(eventMap[cellKey] && eventMap[cellKey].length){
              // show up to 3 event dots
              markerHtml = '<div class="mt-1">';
                eventMap[cellKey].slice(0,3).forEach(ev => {
                  // each dot gets a data-event-id so clicking it can open a details modal
                  const evId = ev.id;
                  const evTitleEsc = (ev.title || '').replace(/\"/g, '&quot;');
                  markerHtml += `<span class="d-inline-block event-dot bg-success rounded-circle me-1" data-event-id="${evId}" style="width:8px;height:8px;cursor:pointer;" title="${evTitleEsc}"></span>`;
                });
              if(eventMap[cellKey].length > 3) markerHtml += '<span class="small text-muted">+'+(eventMap[cellKey].length-3)+'</span>';
              markerHtml += '</div>';
              // add combined tooltip
              const titles = eventMap[cellKey].map(e=>e.title).join(', ');
              cell.setAttribute('title', titles);
            }

            // attach a data-date attribute so we can find this cell from the legend
            cell.setAttribute('data-date', cellKey);
            // make cell have consistent size and inner layout
            cell.classList.add('calendar-cell');
            cell.innerHTML = `<div class="cell-inner">${dateHtml}${markerHtml}</div>`;
            date++;
          }
          row.appendChild(cell);
        }
        calBody.appendChild(row);
        if(date>daysInMonth) break;
      }
      // After calendar cells are rendered, update the legend for the visible month
      renderLegend(month, year);
    }

    if(prevBtn) prevBtn.addEventListener('click', function(){
      currMonth--; if(currMonth<0){ currMonth=11; currYear--; }
      renderCalendar(currMonth, currYear);
    });
    if(nextBtn) nextBtn.addEventListener('click', function(){
      currMonth++; if(currMonth>11){ currMonth=0; currYear++; }
      renderCalendar(currMonth, currYear);
    });

    // Helper: highlight a date cell (adds visual class and scrolls into view)
    function highlightDate(dateKey){
      // remove previous selection
      document.querySelectorAll('#calendar td.legend-selected').forEach(el => el.classList.remove('legend-selected'));
      const cell = document.querySelector(`#calendar td[data-date="${dateKey}"]`);
      if(cell){
        cell.classList.add('legend-selected');
        try{ cell.scrollIntoView({behavior:'smooth', block:'center', inline:'nearest'}); } catch(e){}
      }
    }

    // Open event modal by event id (uses rawEvents array populated by server-side JSON)
    function openEventModal(eventId){
      if(!eventId) return;
      // find event in rawEvents (ids may be numbers or strings)
      const ev = rawEvents.find(x => String(x.id) === String(eventId));
      if(!ev) return;
      const bannerEl = document.getElementById('eventModalBanner');
      const infoEl = document.getElementById('eventModalInfo');
      const registerLink = document.getElementById('eventRegisterLink');

      // Banner
      if(bannerEl) {
        if(ev.banner_url){
          bannerEl.innerHTML = `<img src="${ev.banner_url}" class="img-fluid rounded" alt="${(ev.title||'')}">`;
        } else {
          bannerEl.innerHTML = '<div class="text-muted">No banner</div>';
        }
      }

      // Info
      if(infoEl){
        const parts = [];
        parts.push(`<h5>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${ev.title || ''}</h5>`);
        if(ev.theme) parts.push(`<div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Theme:</strong> ${ev.theme}</div>`);
        if(ev.date) parts.push(`<div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Date:</strong> ${ev.date}</div>`);
        if(ev.chair_name) parts.push(`<div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Chair:</strong> ${ev.chair_name}</div>`);
        if(ev.co_chair_name) parts.push(`<div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Co-Chair:</strong> ${ev.co_chair_name}</div>`);
        parts.push(`<div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Max Attendees:</strong> ${ev.max_attendees == null ? 'N/A' : ev.max_attendees}</div>`);
        parts.push(`<div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Available Slots:</strong> ${ev.available_slots == null ? 'N/A' : ev.available_slots}</div>`);
        parts.push(`<div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Status:</strong> ${ev.status || ''}</div>`);
        infoEl.innerHTML = parts.join('');
      }

      // Register link: point to registration_event with event_id query param if available
      if(registerLink){
        const base = '{% url "registration_event" %}';
        if(ev.id){
          registerLink.setAttribute('href', base + '?event_id=' + encodeURIComponent(ev.id));
        } else {
          registerLink.setAttribute('href', base);
        }
      }

      // show modal (Bootstrap 5)
      try{
        const modalEl = document.getElementById('eventModal');
        const bsModal = new bootstrap.Modal(modalEl);
        bsModal.show();
        // keep reference so dismiss buttons can explicitly hide it if necessary
        activeEventModal = bsModal;
        // when modal hides, clear reference
        modalEl.addEventListener('hidden.bs.modal', function(){ activeEventModal = null; });
      }catch(e){
        console.warn('Bootstrap modal show failed', e);
      }
    }

    // Render legend: list events for the currently visible month and attach click handlers
    function renderLegend(month, year){
      const legendEl = document.getElementById('calendarLegend');
      if(!legendEl) return;
      // Collect events in this month/year
      const items = rawEvents
        .map(ev => {
            if(!ev || !ev.date) return null;
            const d = parseDateOnlyString(ev.date);
            if(!d) return null;
            return {ev: ev, dateObj: d};
          })
        .filter(x => x && x.dateObj.getMonth() === month && x.dateObj.getFullYear() === year)
        .sort((a,b) => a.dateObj - b.dateObj);

      if(items.length === 0){
        legendEl.innerHTML = '<div class="text-muted">No events this month.</div>';
        return;
      }

      let html = '<ul class="list-unstyled mb-0">';
      items.forEach(item => {
        const day = item.dateObj.getDate();
        const title = item.ev.title || 'Untitled';
        const key = item.dateObj.toISOString().slice(0,10);
        const evId = item.ev.id;
        // legend item is a clickable anchor with data-date and data-event-id
        html += `<li><a href="#" class="legend-item" data-date="${key}" data-event-id="${evId}"><span class="d-inline-block bg-success rounded-circle me-2" style="width:8px;height:8px;"></span> <strong>${day}</strong> â€” ${title}</a></li>`;
      });
      html += '</ul>';
      legendEl.innerHTML = html;

      // Attach click handlers to legend items
      legendEl.querySelectorAll('.legend-item').forEach(a => {
        a.addEventListener('click', function(e){
          e.preventDefault();
          const dateKey = this.dataset.date;
          const evId = this.dataset.eventId;
          if(!dateKey) return;
          const d = parseDateOnlyString(dateKey);
          if(!d) return;
          // navigate to the month/year containing the date, then highlight
          currMonth = d.getMonth();
          currYear = d.getFullYear();
          renderCalendar(currMonth, currYear);
          // small delay to allow cells to render
          setTimeout(() => {
            highlightDate(dateKey);
            if(evId) openEventModal(evId);
          }, 120);
        });
      });
    }

    renderCalendar(currMonth, currYear);
  })();
</script>
{% comment %} </div> {% endcomment %}

<!-- DITO ANG END NG BODY. WAG KA LALAMPAS -->

{% endblock %}
