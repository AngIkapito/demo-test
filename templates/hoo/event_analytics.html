{% extends "includes/base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid py-4">
	<!-- Header: title + controls (professional) -->
	<div class="analytics-header mb-4 p-3 rounded-3 shadow-sm bg-white d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
		<div>
			<h1 class="h3 mb-1 text-dark">Event Analytics</h1>
			<p class="text-muted mb-0">Realtime insights â€” registrations, attendance, competitors, and trends.</p>
		</div>

		<div class="d-flex align-items-center gap-3 w-100 w-md-auto">
			<div class="me-2">
				<label class="small text-muted mb-1 d-block">Cycle</label>
				<select id="cycle_select" class="form-select form-select-sm">
					{% for sy in school_years %}
						<option value="{{ sy.id }}">{{ sy.sy_start|date:'Y' }} - {{ sy.sy_end|date:'Y' }}</option>
					{% endfor %}
				</select>
			</div>

			<div>
				<label class="small text-muted mb-1 d-block">Event</label>
				<select id="event_select" class="form-select form-select-sm">
					<option value="">-- Select Event --</option>
				</select>
			</div>
		</div>
	</div>

	<!-- Main content: left panel (event) + right panel (analytics) -->
	<div class="row gy-4">
		<style>
		/* Professional analytics styles */
		:root{--accent:#4e73df;--muted:#6c757d}
		.card-compact .card-body{padding:.75rem}
		.metric-card .card-body{padding:1rem}
		.metric-value{font-size:1.6rem; font-weight:700;color:var(--accent)}
		.metric-label{font-size:.8rem;color:var(--muted)}
		#chart{min-height:320px}
		#pie_chart{max-width:420px; margin:0 auto; min-height:300px}
		.analytics-header { border-left: 4px solid var(--accent); }
		.chart-card { border: 0; box-shadow: 0 6px 18px rgba(33,37,41,.06); }
		.small-muted { color: var(--muted); }
		@media (max-width:767px){ .metric-value{font-size:1.2rem} }
		</style>

		<div class="col-lg-6">
			<div class="d-flex flex-column gap-3">
				<div class="card shadow-sm card-compact">
					<div class="card-body">
						<div class="d-flex align-items-start">
							<div class="flex-grow-1">
								<h6 class="text-muted mb-1">Active Event</h6>
								{% if event %}
									<h5 class="fw-bold text-primary mb-1" id="event_title_display">{{ event.title }}</h5>
									<div class="small text-muted mb-1" id="event_date_display">{% if event.date %}{{ event.date }}{% endif %}</div>
									<div><span id="event_status_badge" class="badge {% if event.status == 'active' %}bg-success{% elif event.status == 'inactive' %}bg-danger{% else %}bg-secondary{% endif %}">{{ event.status|capfirst }}</span></div>
								{% else %}
									<div class="text-muted">No active event at the moment.</div>
								{% endif %}
								<p class="mb-0 text-muted small mt-2">Use the controls to switch cycles and events.</p>
							</div>
							<div class="ms-3 align-self-center">
								<i class="fas fa-calendar-check fa-2x text-gray-400"></i>
							</div>
						</div>
					</div>
				</div>

				<!-- Removed Pie Chart Card -->
				<div class="card shadow-sm text-center">
					<div class="card-body">
						<h6 class="text-muted mb-2">Attending As</h6>
						<div id="pie_chart"></div>
					</div>
				</div>
			</div>
		</div>

		<div class="col-lg-6">
			<div class="row g-3">
				<div class="col-6 col-md-3">
					<div class="card chart-card metric-card p-2">
						<div class="card-body text-center">
							<div class="metric-label">Registered</div>
							<div id="registered_count" class="metric-value">{{ registered_total|default:'0' }}</div>
						</div>
					</div>
				</div>
				<div class="col-6 col-md-3">
					<div class="card chart-card metric-card p-2">
						<div class="card-body text-center">
							<div class="metric-label">Attended</div>
							<div id="attended_count" class="metric-value">{{ attended_total|default:'0' }}</div>
						</div>
					</div>
				</div>
				<div class="col-6 col-md-3">
					<div class="card chart-card metric-card p-2">
						<div class="card-body text-center">
							<div class="metric-label">Competitors</div>
							<div id="competitor_count" class="metric-value">0</div>
						</div>
					</div>
				</div>
				<div class="col-6 col-md-3">
					<div class="card chart-card metric-card p-2">
						<div class="card-body text-center">
							<div class="metric-label">Conversion</div>
							<div id="conversion_rate" class="metric-value">0%</div>
						</div>
					</div>
				</div>
			</div>

			<div class="card shadow-sm mt-3">
				<div class="card-body" style="min-height:340px;">
					<div id="analytics_chart" style="height:100%;">
						<div id="chart" style="height:100%;"></div>
					</div>
				</div>
			</div>

			<div class="card shadow-sm mt-3">
				<div class="card-body" style="min-height:380px;">
					<div id="grouped_chart" style="height:380px;"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- client-side wiring for dropdowns -->
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		var eventsData = [];
		try { eventsData = JSON.parse('{{ events_json|default:'[]'|escapejs }}'); } catch(e){ eventsData = []; }

		var cycleSelect = document.getElementById('cycle_select');
		var eventSelect = document.getElementById('event_select');
		var titleEl = document.getElementById('event_title_display');
		var dateEl = document.getElementById('event_date_display');

		function clearEvents() {
			eventSelect.innerHTML = '';
			var placeholder = document.createElement('option');
			placeholder.value = '';
			placeholder.textContent = '-- Select Event --';
			eventSelect.appendChild(placeholder);
		}

		function populateEventsForCycle(cycleId){
			clearEvents();
			eventsData.forEach(function(ev){
					if(String(ev.school_year_id) === String(cycleId)){
					var opt = document.createElement('option');
					opt.value = ev.id;
					opt.textContent = ev.title;
						opt.dataset.date = ev.date || '';
						opt.dataset.status = ev.status || '';
					eventSelect.appendChild(opt);
				}
			});
		}

		if(cycleSelect){
			cycleSelect.addEventListener('change', function(e){
				populateEventsForCycle(e.target.value);
				if(titleEl) titleEl.textContent = '';
				if(dateEl) dateEl.textContent = '';
			});
			var initial = cycleSelect.value || (cycleSelect.options.length ? cycleSelect.options[0].value : null);
			if(initial) populateEventsForCycle(initial);
		}

		// Auto-select the active event (from server) and trigger the change handler
		try{
			var activeEventId = '{{ event.id|default:"" }}';
			if(activeEventId && eventSelect){
				var found = Array.from(eventSelect.options).find(function(o){ return String(o.value) === String(activeEventId); });
				if(found){
					found.selected = true;
					var evt = new Event('change', { bubbles: true });
					eventSelect.dispatchEvent(evt);
				}
			}
		}catch(e){ /* ignore */ }

		if(eventSelect){
				eventSelect.addEventListener('change', function(e){
							var sel = e.target.selectedOptions[0];
							if(sel && sel.value){
								if(titleEl) titleEl.textContent = sel.textContent;
								if(dateEl) dateEl.textContent = sel.dataset.date || '';

								// update status badge
								var badge = document.getElementById('event_status_badge');
								if(badge){
									var st = sel.dataset.status || '';
									badge.textContent = st ? (st.charAt(0).toUpperCase() + st.slice(1)) : '';
									var cls = 'badge ';
									if(st === 'active') cls += 'bg-success';
									else if(st === 'inactive') cls += 'bg-danger';
									else if(st === 'cancelled' || st === '') cls += 'bg-secondary';
									else cls += 'bg-info';
									badge.className = cls;
								}

								// fetch counts + org breakdown for selected event
								var eventId = sel.value;
								fetch('/hoo/Event/Stats/' + eventId + '/')
									.then(function(res){ return res.json(); })
									.then(function(data){
										var regEl = document.getElementById('registered_count');
										var attEl = document.getElementById('attended_count');
										if(data && typeof data.registered_total !== 'undefined'){
											if(regEl) regEl.textContent = data.registered_total;
											if(attEl) attEl.textContent = data.attended_total;
										} else {
											if(regEl) regEl.textContent = '0';
											if(attEl) attEl.textContent = '0';
										}

										// update chart if organizations data present
										if(data && Array.isArray(data.organizations) && window.eventOrgChart){
											var orgs = data.organizations || [];
											// sort descending by value so largest bars appear first
											orgs.sort(function(a,b){ return (b.value || 0) - (a.value || 0); });
											var cats = orgs.map(function(o){ return o.initials || o.name || ''; });
											var vals = orgs.map(function(o){ return o.value || 0; });
											try{
												window.eventOrgChart.updateOptions({ xaxis: { categories: cats } });
												window.eventOrgChart.updateSeries([{ name: 'Count', data: vals }]);
											}catch(e){
												// fallback: recreate chart
												var chartEl = document.querySelector('#chart');
												if(chartEl){
													window.eventOrgChart.destroy();
													window.eventOrgChart = new ApexCharts(chartEl, {
														series:[{ name: 'Count', data: vals }],
														chart:{ type:'bar', height:350 },
														plotOptions:{ bar:{ borderRadius:4, borderRadiusApplication:'end', horizontal:true } },
														dataLabels:{ enabled:false },
														xaxis:{ categories: cats }
													});
													window.eventOrgChart.render();
												}
											}
										}
									})
									.catch(function(){
										var regEl = document.getElementById('registered_count');
										var attEl = document.getElementById('attended_count');
										if(regEl) regEl.textContent = '0';
										if(attEl) attEl.textContent = '0';
									});
							} else {
								if(titleEl) titleEl.textContent = '';
								if(dateEl) dateEl.textContent = '';
								var regEl = document.getElementById('registered_count');
								var attEl = document.getElementById('attended_count');
								if(regEl) regEl.textContent = '0';
								if(attEl) attEl.textContent = '0';

								var badge = document.getElementById('event_status_badge');
								if(badge){ badge.textContent = ''; badge.className = 'badge bg-secondary'; }
							}
						});
		}
	});
	</script>

	<!-- ApexCharts chart for organization initials -->
	<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
	<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		var orgs = [];
		try { orgs = JSON.parse('{{ organizations_json|default:'[]'|escapejs }}'); } catch(e){ orgs = []; }

		// sort descending by value so largest bars appear first
		orgs.sort(function(a,b){ return (b.value || 0) - (a.value || 0); });

		var categories = orgs.map(function(o){ return o.initials || o.name || ''; });
		// Try common numeric fields for values, fall back to 0
		var values = orgs.map(function(o){ return (o.value || o.registered_total || o.count || 0); });

				var options = {
					series: [{ name: 'Count', data: values }],
		  chart: { type: 'bar', height: 350 },
		  plotOptions: { bar: { borderRadius: 4, borderRadiusApplication: 'end', horizontal: true } },
		  dataLabels: { enabled: false },
		  xaxis: { categories: categories }
		};

		var chartEl = document.querySelector("#chart");
		if(chartEl){
			// store chart globally so we can update it on event change
			window.eventOrgChart = new ApexCharts(chartEl, options);
			window.eventOrgChart.render();
		}
	});
	</script>

	<!-- Grouped column chart under analytics (competitor counts) -->
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		var groupedEl = document.querySelector('#grouped_chart');
		if(!groupedEl) return;

		function renderGrouped(labels, series){
			var opts = {
				series: [{ name: 'Competitors', data: series }],
				chart: { type: 'bar', height: 380 },
				plotOptions: { bar: { borderRadius: 4 } },
				dataLabels: { enabled: false },
				xaxis: { categories: labels },
				title: { text: 'Competitor Breakdown' },
				tooltip: { y: { formatter: function(val){ return String(val); } } }
			};

			if(window.eventGroupedChart){
				try{
					window.eventGroupedChart.updateOptions({ xaxis: { categories: labels }, chart: opts.chart });
					window.eventGroupedChart.updateSeries(opts.series);
				}catch(e){
					try{ window.eventGroupedChart.destroy(); }catch(e){}
					window.eventGroupedChart = new ApexCharts(groupedEl, opts);
					window.eventGroupedChart.render();
				}
			} else {
				window.eventGroupedChart = new ApexCharts(groupedEl, opts);
				window.eventGroupedChart.render();
			}
		}

		function updateGroupedChart(eventId){
			if(!eventId){ renderGrouped([], []); return; }
			fetch('/hoo/Event/CompetitorCounts/' + eventId + '/')
				.then(function(res){ return res.json(); })
				.then(function(data){
					var labels = Array.isArray(data.labels) ? data.labels : [];
					var series = Array.isArray(data.series) ? data.series : [];
					renderGrouped(labels, series);
				})
				.catch(function(){ renderGrouped([], []); });
		}

		var eventSelect = document.getElementById('event_select');
		if(eventSelect){
			eventSelect.addEventListener('change', function(e){
				var sel = e.target.selectedOptions[0];
				var id = sel ? sel.value : null;
				updateGroupedChart(id);
			});
		}

		try{
			var activeEventId = '{{ event.id|default:"" }}';
			if(activeEventId){ updateGroupedChart(activeEventId); }
		}catch(e){}
	});
	</script>

	<!-- Lightweight metrics updater: fetch competitor counts and compute conversion -->
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		function updateMetrics(eventId){
			if(!eventId) return;
			// fetch competitor counts
			fetch('/hoo/Event/CompetitorCounts/' + eventId + '/')
				.then(function(res){ return res.json(); })
				.then(function(data){
					var series = Array.isArray(data.series) ? data.series : [];
					var totalCompetitors = series.reduce(function(acc, v){ return acc + (Number(v)||0); }, 0);
					var compEl = document.getElementById('competitor_count');
					if(compEl) compEl.textContent = totalCompetitors;
				}).catch(function(){ /* ignore */ });

			// fetch registered/attended totals to compute conversion
			fetch('/hoo/Event/Stats/' + eventId + '/')
				.then(function(res){ return res.json(); })
				.then(function(data){
					var reg = Number(data.registered_total) || 0;
					var att = Number(data.attended_total) || 0;
					var conv = reg > 0 ? Math.round((att / reg) * 100) : 0;
					var convEl = document.getElementById('conversion_rate');
					if(convEl) convEl.textContent = conv + '%';
				}).catch(function(){ /* ignore */ });
		}

		var eventSelect = document.getElementById('event_select');
		if(eventSelect){
			eventSelect.addEventListener('change', function(e){
				var sel = e.target.selectedOptions[0];
				var id = sel ? sel.value : null;
				updateMetrics(id);
			});
		}

		try{
			var activeEventId = '{{ event.id|default:"" }}';
			if(activeEventId) updateMetrics(activeEventId);
		}catch(e){}
	});
	</script>

	<!-- Dynamic pie chart for active event (inside left column card) -->
	<script>
	document.addEventListener('DOMContentLoaded', function(){
		var pieEl = document.querySelector('#pie_chart');
		if(!pieEl) return;

		function renderOrUpdatePie(labels, series){
				var opts = {
					series: series || [],
					chart: { type: 'pie', width: Math.min(420, pieEl.clientWidth || 420), height: 320 },
					labels: labels || [],
					responsive: [{ breakpoint: 480, options: { chart: { width: 200, height: 200 }, legend: { position: 'bottom' } } }]
				};

			if(window.eventPieChart){
				try{
					window.eventPieChart.updateOptions({ labels: opts.labels, chart: opts.chart });
					window.eventPieChart.updateSeries(opts.series);
				}catch(e){
					window.eventPieChart.destroy();
					window.eventPieChart = new ApexCharts(pieEl, opts);
					window.eventPieChart.render();
				}
			} else {
				window.eventPieChart = new ApexCharts(pieEl, opts);
				window.eventPieChart.render();
			}
		}

		// fetch pie data for a given event id and render
		function updatePieForEvent(eventId){
			if(!eventId) {
				renderOrUpdatePie([], []);
				return;
			}
			fetch('/hoo/Event/AttendingPie/' + eventId + '/')
				.then(function(res){ return res.json(); })
				.then(function(data){
					var labels = Array.isArray(data.labels) ? data.labels : [];
					var series = Array.isArray(data.series) ? data.series : [];
					renderOrUpdatePie(labels, series);
				})
				.catch(function(){ renderOrUpdatePie([], []); });
		}

		// wire into existing event select change behavior by listening for changes
		var eventSelect = document.getElementById('event_select');
		if(eventSelect){
			eventSelect.addEventListener('change', function(e){
				var sel = e.target.selectedOptions[0];
				var id = sel ? sel.value : null;
				updatePieForEvent(id);
			});
		}

		// initial load: if an active event id is present from server, request its pie
		try{
			var activeEventId = '{{ event.id|default:"" }}';
			if(activeEventId){ updatePieForEvent(activeEventId); }
		}catch(e){}
	});
	</script>


</div>

{% endblock %}


